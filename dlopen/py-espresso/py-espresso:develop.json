{
    "matches": {
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/src/core/communication.cpp": "/*\n * Copyright (C) 2010-2019 The ESPResSo project\n * Copyright (C) 2002,2003,2004,2005,2006,2007,2008,2009,2010\n *   Max-Planck-Institute for Polymer Research, Theory Group\n *\n * This file is part of ESPResSo.\n *\n * ESPResSo is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * ESPResSo is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n#include \"communication.hpp\"\n\n#include \"errorhandling.hpp\"\n#include \"event.hpp\"\n#include \"grid.hpp\"\n\n#include <utils/mpi/cart_comm.hpp>\n\n#include <boost/mpi.hpp>\n\n#include <mpi.h>\n#ifdef OPEN_MPI\n#include <dlfcn.h>\n#endif\n\n#include <cassert>\n#include <cstdio>\n#include <cstdlib>\n#include <memory>\n\nnamespace Communication {\nauto const &mpi_datatype_cache = boost::mpi::detail::mpi_datatype_cache();\nstd::shared_ptr<boost::mpi::environment> mpi_env;\n} // namespace Communication\n\nboost::mpi::communicator comm_cart;\n\nnamespace Communication {\nstd::unique_ptr<MpiCallbacks> m_callbacks;\n\n/* We use a singleton callback class for now. */\nMpiCallbacks &mpiCallbacks() {\n  assert(m_callbacks && \"Mpi not initialized!\");\n\n  return *m_callbacks;\n}\n} // namespace Communication\n\nusing Communication::mpiCallbacks;\n\nint this_node = -1;\nint n_nodes = -1;\n\n#if defined(OPEN_MPI)\nnamespace {\n/** Workaround for \"Read -1, expected XXXXXXX, errno = 14\" that sometimes\n *  appears when CUDA is used. This is a bug in OpenMPI 2.0-2.1.2 and 3.0.0\n *  according to\n *  https://www.mail-archive.com/users@lists.open-mpi.org/msg32357.html,\n *  so we set btl_vader_single_copy_mechanism = none.\n */\nvoid openmpi_fix_vader() {\n  if ((OMPI_MAJOR_VERSION == 2 && OMPI_MINOR_VERSION == 1 &&\n       OMPI_RELEASE_VERSION < 3) or\n      (OMPI_MAJOR_VERSION == 3 && OMPI_MINOR_VERSION == 0 &&\n       OMPI_RELEASE_VERSION == 0)) {\n    setenv(\"OMPI_MCA_btl_vader_single_copy_mechanism\", \"none\", 0);\n  }\n}\n\n/**\n * @brief Assure that openmpi is loaded to the global namespace.\n *\n * This was originally inspired by mpi4py\n * (https://github.com/mpi4py/mpi4py/blob/4e3f47b6691c8f5a038e73f84b8d43b03f16627f/src/lib-mpi/compat/openmpi.h).\n * It's needed because OpenMPI dlopens its submodules. These are unable to find\n * the top-level OpenMPI library if that was dlopened itself, i.e. when the\n * Python interpreter dlopens a module that is linked against OpenMPI. It's\n * about some weird two-level symbol namespace thing.\n */\nvoid openmpi_global_namespace() {\n  if (OMPI_MAJOR_VERSION >= 3)\n    return;\n#ifdef RTLD_NOLOAD\n  const int mode = RTLD_NOW | RTLD_GLOBAL | RTLD_NOLOAD;\n#else\n  const int mode = RTLD_NOW | RTLD_GLOBAL;\n#endif\n\n  const void *_openmpi_symbol = dlsym(RTLD_DEFAULT, \"MPI_Init\");\n  if (!_openmpi_symbol) {\n    fprintf(stderr, \"Aborting because unable to find OpenMPI symbol.\\n\");\n    errexit();\n  }\n\n  Dl_info _openmpi_info;\n  dladdr(_openmpi_symbol, &_openmpi_info);\n\n  const void *handle = dlopen(_openmpi_info.dli_fname, mode);\n\n  if (!handle) {\n    fprintf(stderr, \"Aborting because unable to load libmpi into the \"\n                    \"global symbol space.\\n\");\n    errexit();\n  }\n}\n} // namespace\n#endif\n\nnamespace Communication {\nvoid init(std::shared_ptr<boost::mpi::environment> mpi_env) {\n  Communication::mpi_env = std::move(mpi_env);\n\n  MPI_Comm_size(MPI_COMM_WORLD, &n_nodes);\n  node_grid = Utils::Mpi::dims_create<3>(n_nodes);\n\n  comm_cart =\n      Utils::Mpi::cart_create(comm_cart, node_grid, /* reorder */ false);\n\n  this_node = comm_cart.rank();\n\n  Communication::m_callbacks =\n      std::make_unique<Communication::MpiCallbacks>(comm_cart);\n\n  ErrorHandling::init_error_handling(mpiCallbacks());\n\n  on_program_start();\n}\n} // namespace Communication\n\nstd::shared_ptr<boost::mpi::environment> mpi_init() {\n#ifdef OPEN_MPI\n  openmpi_fix_vader();\n  openmpi_global_namespace();\n#endif\n\n  return std::make_shared<boost::mpi::environment>();\n}\n\nvoid mpi_loop() {\n  if (this_node != 0)\n    mpiCallbacks().loop();\n}\n"
    },
    "skipped": [
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/.git/objects/pack/pack-28936892c4fcfa3bcb1c495545b24a58680767eb.idx",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/.git/objects/pack/pack-28936892c4fcfa3bcb1c495545b24a58680767eb.pack",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/particles.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/bond_angle.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/dihedral_angle.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/logo.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/ghost_cells.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/linked_cells.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/dihedral_angle.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/elc_errordist.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/datastorage.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/directions.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/move_to_p_buf.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/ghost_communication.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/doxygen/figs/conical_frustum.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/vs-code-settings.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oif2.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/constraint-force_only_positive.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oif-bending.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oifchannel.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/diamond.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/constraint-force.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/shape-spherocylinder.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/shape-cylinder.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oifcolored-triangles.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oif-stretching.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oif3.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oif.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/shape-conical_frustum.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/dihedral-angle.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/ccmake-example.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/shape-ellipsoid.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oif-volcons.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/elc-errordist.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/constraint-distance.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oif1.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/correlator_scheme.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/slitpore.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oifvectordata.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/correlator_scheme.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/inter_angle.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/conical_frustum.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oifrhomboid.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oifcylinder.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/shape-wall.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/shape-simplepore.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/shape-sphere.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/shape-torus.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oifstretched-sphere.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/shape-slitpore.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/sphinx/figures/oif-arealocal.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/lattice_boltzmann/figures/latticeboltzmann-momentumexchange.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/lattice_boltzmann/figures/latticeboltzmann-grid.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/lattice_boltzmann/figures/poiseuille.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/raspberry_electrophoresis/figures/raspberry_snapshot.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/raspberry_electrophoresis/figures/raspberry_snapshot.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/ferrofluid/figures/Electro-Steric_Stabilization.jpg",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/ferrofluid/figures/headtotailconf.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/ferrofluid/figures/Ferrofluid_Magnet_under_glass_edit.jpg",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/electrokinetics/figures/profiles.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/electrokinetics/figures/schlitzpore_3d.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/electrokinetics/figures/latticeboltzmann-grid.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/active_matter/figures/rectify.jpg",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/active_matter/figures/rectification.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/active_matter/figures/geometry.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/active_matter/figures/friction.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/active_matter/figures/enhanced.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/active_matter/figures/pusher-puller.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/active_matter/figures/flow_field.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/tutorials/lennard_jones/figures/lennard-jones-potential.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo_48x48.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/cup.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo_500x500.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo-animated-200.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo_100x100.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo-small.pdf",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/cup-nosteam.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo-animated-500.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo_32x32.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo-small_200x200.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/favicon.png",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/favicon.ico",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/doc/logo/logo-animated-100.gif",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/testsuite/python/data/coulomb_tuning_system.npz",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/testsuite/python/data/dipolar_open_boundaries_arrays.npy",
        "/tmp/vanessa/spack-stage/spack-stage-py-espresso-develop-cbde2mzxqakz5hznwiftdp2kbbw44wgy/spack-src/testsuite/python/data/dipolar_open_boundaries_energy.npy"
    ],
    "total_files": 1427
}