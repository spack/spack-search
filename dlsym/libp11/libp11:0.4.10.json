{
    "matches": {
        "/tmp/vanessa/spack-stage/spack-stage-libp11-0.4.10-6l5a322aiqzwq7pr4e2e4qoxtnbil3d7/spack-src/src/libpkcs11.c": "/* libp11, a simple layer on to of PKCS#11 API\n * Copyright (C) 2005 Olaf Kirch <okir@lst.de>\n *\n *  This library is free software; you can redistribute it and/or\n *  modify it under the terms of the GNU Lesser General Public\n *  License as published by the Free Software Foundation; either\n *  version 2.1 of the License, or (at your option) any later version.\n *\n *  This library is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n *  Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; if not, write to the Free Software\n *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA\n */\n\n/*\n * Convenience pkcs11 library that can be linked into an application,\n * and will bind to a specific pkcs11 module.\n *\n * Copyright (C) 2002  Olaf Kirch <okir@lst.de>\n */\n\n#include \"libp11-int.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <string.h>\n#ifdef _WIN32\n#include <windows.h>\n#else\n#include <dlfcn.h>\n#endif\n\n#define MAGIC\t\t\t0xd00bed00\n\nstruct sc_pkcs11_module {\n\tunsigned int _magic;\n\tvoid *handle;\n};\ntypedef struct sc_pkcs11_module sc_pkcs11_module_t;\n\n/*\n * Load a module - this will load the shared object, call\n * C_Initialize, and get the list of function pointers\n */\nvoid *\nC_LoadModule(const char *mspec, CK_FUNCTION_LIST_PTR_PTR funcs)\n{\n\tsc_pkcs11_module_t *mod;\n\tCK_RV (*c_get_function_list)(CK_FUNCTION_LIST_PTR_PTR);\n\tint rv;\n\n\tif (mspec == NULL)\n\t\treturn NULL;\n\n\tmod = OPENSSL_malloc(sizeof(sc_pkcs11_module_t));\n\tif (mod == NULL)\n\t\treturn NULL;\n\tmemset(mod, 0, sizeof(sc_pkcs11_module_t));\n\tmod->_magic = MAGIC;\n\n#ifdef WIN32\n\tmod->handle = LoadLibraryA(mspec);\n#else\n\tmod->handle = dlopen(mspec, RTLD_LAZY | RTLD_LOCAL);\n#endif\n\n\tif (mod->handle == NULL) {\n#ifndef WIN32\n\t\tfprintf(stderr, \"%s\\n\", dlerror());\n#endif\n\t\tgoto failed;\n\t}\n\n#ifdef WIN32\n\tc_get_function_list = (CK_C_GetFunctionList)\n\t\tGetProcAddress(mod->handle, \"C_GetFunctionList\");\n#else\n\t{\n\t\t/*\n\t\t * Make compiler happy!\n\t\t */\n\t\tvoid *p = dlsym(mod->handle, \"C_GetFunctionList\");\n\t\tmemmove(&c_get_function_list, &p, sizeof(void *));\n\t}\n#endif\n\n\tif (c_get_function_list == NULL) {\n#ifndef WIN32\n\t\tfprintf(stderr, \"%s\\n\", dlerror());\n#endif\n\t\tgoto failed;\n\t}\n\trv = c_get_function_list(funcs);\n\tif (rv == CKR_OK)\n\t\treturn mod;\n\nfailed:\n\tC_UnloadModule((void *) mod);\n\treturn NULL;\n}\n\n/*\n * Unload a pkcs11 module.\n * The calling application is responsible for cleaning up\n * and calling C_Finalize\n */\nCK_RV\nC_UnloadModule(void *module)\n{\n\tsc_pkcs11_module_t *mod = (sc_pkcs11_module_t *) module;\n\n\tif (mod == NULL || mod->_magic != MAGIC)\n\t\treturn CKR_ARGUMENTS_BAD;\n\n\tif (mod->handle) {\n#ifdef WIN32\n\t\tFreeLibrary(mod->handle);\n#else\n\t\tdlclose(mod->handle);\n#endif\n\t}\n\n\tmemset(mod, 0, sizeof(sc_pkcs11_module_t));\n\tOPENSSL_free(mod);\n\n\treturn CKR_OK;\n}\n\n/* vim: set noexpandtab: */\n"
    },
    "skipped": [
        "/tmp/vanessa/spack-stage/spack-stage-libp11-0.4.10-6l5a322aiqzwq7pr4e2e4qoxtnbil3d7/spack-src/tests/rsa-pubkey.der",
        "/tmp/vanessa/spack-stage/spack-stage-libp11-0.4.10-6l5a322aiqzwq7pr4e2e4qoxtnbil3d7/spack-src/tests/rsa-cert.der",
        "/tmp/vanessa/spack-stage/spack-stage-libp11-0.4.10-6l5a322aiqzwq7pr4e2e4qoxtnbil3d7/spack-src/tests/ec-pubkey.der",
        "/tmp/vanessa/spack-stage/spack-stage-libp11-0.4.10-6l5a322aiqzwq7pr4e2e4qoxtnbil3d7/spack-src/tests/ec-cert.der",
        "/tmp/vanessa/spack-stage/spack-stage-libp11-0.4.10-6l5a322aiqzwq7pr4e2e4qoxtnbil3d7/spack-src/tests/rsa-prvkey.der",
        "/tmp/vanessa/spack-stage/spack-stage-libp11-0.4.10-6l5a322aiqzwq7pr4e2e4qoxtnbil3d7/spack-src/tests/ec-prvkey.der",
        "/tmp/vanessa/spack-stage/spack-stage-libp11-0.4.10-6l5a322aiqzwq7pr4e2e4qoxtnbil3d7/spack-src/doc/opensc-logo.gif"
    ],
    "total_files": 85
}